# -*- coding: utf-8 -*-
"""Untitled17.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1eXC7zJPr4XJ4uHj5cjOkW1G50y_8Vbj-
"""

import streamlit as st
from supabase import create_client, Client
import pandas as pd

# --- Koneksi ke Supabase ---
url = "https://cckdfjxowgowgxufnhnj.supabase.co"
key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNja2Rmanhvd2dvd2d4dWZuaG5qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NDY4NDgsImV4cCI6MjA3NzEyMjg0OH0.JXb-yqbBu_OSLpG03AlnfZI5K_eRKyhfGw4glE0Cj0o"
supabase: Client = create_client(url, key)

st.set_page_config(page_title="Talent Match Intelligence", layout="wide")
st.title("Talent Match Intelligence Dashboard")

st.title("1. Role Information")

# --- Ambil data dari Supabase
data = supabase.table("talent_benchmark").select("*").execute().data

# --- Dropdown Role Name
role_names = sorted(list(set([d["role_name"] for d in data])))
selected_role = st.selectbox("Role Name", role_names)

# --- Auto-filter Job Level berdasar Role Name
job_levels = sorted(list(set([d["job_level"] for d in data if d["role_name"] == selected_role])))
selected_job_level = st.selectbox("Job Level", job_levels)

# --- Role Purpose
role_purpose = st.text_area("Role Purpose", placeholder="1‚Äì2 sentences to describe role outcome")

st.markdown("Example: Ensure production targets are met with optimal quality and cost efficiency")

# --- Employee Benchmarking
employees = [
    f"{d['employee_id']} - {d['fullname']} ({d['role_name']})"
    for d in data
]
selected_benchmarks = st.multiselect("Select Employee Benchmarking (max 3)", employees, max_selections=3)
selected_ids = [s.split(" - ")[0] for s in selected_benchmarks]

# --- Tombol Generate
if st.button("Generate Job Description & Variable Score"):
    if not selected_ids:
        st.warning("Please select at least one benchmark employee.")
    else:
        result = supabase.rpc("talent_match_scoring", {"benchmarks_ids": selected_ids}).execute()
        st.dataframe(result.data)
        
# -- Analysis        
if st.button("üîç Jalankan Analisis"):
    emp_ids = [x.strip() for x in benchmark_input.split(",") if x.strip()]
    array_input = "{" + ",".join(emp_ids) + "}"

    # --- Panggil function di Supabase ---
    data = supabase.rpc("talent_match_scoring", {"benchmark_ids": emp_ids}).execute()

    if data.data:
        df = pd.DataFrame(data.data)
        st.success(f"Hasil untuk benchmark: {', '.join(emp_ids)}")
        st.dataframe(df)

        # --- Tampilkan final match rate ranking ---
        rank_df = df[['employee_id', 'final_match_rate']].drop_duplicates().sort_values(
            by='final_match_rate', ascending=False
        )
        st.bar_chart(rank_df.set_index('employee_id'))
    else:
        st.warning("Tidak ada hasil ditemukan.")
