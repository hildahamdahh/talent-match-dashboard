# -*- coding: utf-8 -*-
"""Untitled17.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1eXC7zJPr4XJ4uHj5cjOkW1G50y_8Vbj-
"""

# ==========================================================
# üéØ Talent Match Intelligence Dashboard (FINAL + JOB DETAILS)
# ==========================================================
import streamlit as st
from supabase import create_client, Client
import pandas as pd
import requests
import json
import re
from datetime import datetime

# --- Koneksi ke Supabase ---
url = "https://cckdfjxowgowgxufnhnj.supabase.co"
key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNja2Rmanhvd2dvd2d4dWZuaG5qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NDY4NDgsImV4cCI6MjA3NzEyMjg0OH0.JXb-yqbBu_OSLpG03AlnfZI5K_eRKyhfGw4glE0Cj0o"
supabase: Client = create_client(url, key)

# --- Page Setup ---
st.set_page_config(page_title="Talent Match Intelligence", layout="wide")
st.title("üéØ Talent Match Intelligence Dashboard")

# ==========================================================
# üß© STEP 1: Ambil data benchmark dari Supabase
# ==========================================================
try:
    response = supabase.table("talent_benchmark").select("*").execute()
    benchmark_data = response.data
except Exception as e:
    st.error(f"Gagal mengambil data: {e}")
    st.stop()

if not benchmark_data:
    st.warning("Tabel 'talent_benchmark' masih kosong.")
    st.stop()

df_benchmark = pd.DataFrame(benchmark_data)

# ==========================================================
# üß≠ STEP 2: Input dari user (parameter runtime)
# ==========================================================
st.subheader("1Ô∏è‚É£ Role Information")

role_names = sorted(df_benchmark["role_name"].dropna().unique())
selected_role = st.selectbox("Role Name", role_names)

filtered_df = df_benchmark[df_benchmark["role_name"] == selected_role]
job_levels = filtered_df["job_level"].dropna().unique()
selected_job_level = st.selectbox("Job Level", job_levels)

role_purpose = st.text_area(
    "Role Purpose",
    placeholder="Contoh: Ensure production targets are met with optimal quality and cost efficiency"
)

# ==========================================================
# üë• STEP 3: Pilih Employee Benchmark
# ==========================================================
st.subheader("2Ô∏è‚É£ Employee Benchmarking")

employee_options = [
    f"{row['employee_id']} - {row['fullname']} ({row['role_name']})"
    for _, row in filtered_df.iterrows()
]
selected_employees = st.multiselect(
    "Pilih maksimal 3 karyawan sebagai benchmark:",
    options=employee_options,
    max_selections=3
)
selected_ids = [emp.split(" - ")[0] for emp in selected_employees]

# ==========================================================
# üß† STEP 4: AI Job Profile Generator (OpenRouter)
# ==========================================================
def generate_job_profile(role_name, job_level, role_purpose):
    try:
        OPENROUTER_API_KEY = st.secrets["OPENROUTER_API_KEY"]
    except Exception:
        st.error("‚ùå OPENROUTER_API_KEY belum diset di secrets.")
        return None

    headers = {
        "Authorization": f"Bearer {OPENROUTER_API_KEY}",
        "HTTP-Referer": "https://talent-match-intelligence.streamlit.app",
        "X-Title": "Talent Match Intelligence",
        "Content-Type": "application/json",
    }

    prompt = f"""
    You are an HR Talent Intelligence Assistant.
    Generate a clear, structured job profile for a {job_level} {role_name}.
    Include:
    1Ô∏è‚É£ Job Requirements
    2Ô∏è‚É£ Job Description
    3Ô∏è‚É£ Key Competencies
    Context: {role_purpose}
    """

    payload = {
        "model": "openai/gpt-4o-mini",
        "messages": [
            {"role": "system", "content": "You generate concise job profiles for HR."},
            {"role": "user", "content": prompt}
        ]
    }

    response = requests.post(
        "https://openrouter.ai/api/v1/chat/completions",
        headers=headers,
        data=json.dumps(payload)
    )

    if response.status_code == 200:
        return response.json()["choices"][0]["message"]["content"]
    else:
        return f"‚ö†Ô∏è Error dari OpenRouter: {response.status_code} - {response.text}"


# ==========================================================
# üöÄ STEP 5: COMBINED BUTTON (SQL + AI)
# ==========================================================
if st.button("‚ú® Generate Job Profile & Variable Score"):
    if not selected_ids:
        st.warning("Pilih minimal 1 benchmark employee terlebih dahulu.")
    else:
        with st.spinner("‚è≥ Menjalankan analisis dan AI generation..."):
            try:
                # --- 1Ô∏è‚É£ Jalankan Function di Supabase ---
                result = supabase.rpc("talent_match_scoring", {"benchmark_ids": selected_ids}).execute()
                data = result.data

                if data:
                    df_result = pd.DataFrame(data)
                    st.success(f"Hasil untuk role: {selected_role} (Job Level: {selected_job_level})")

                    rank_df = (
                        df_result[["employee_id", "final_match_rate"]]
                        .drop_duplicates()
                        .sort_values(by="final_match_rate", ascending=False)
                    )

                    st.subheader("üìä Final Match Rate per Employee")
                    st.dataframe(rank_df)
                    st.bar_chart(rank_df.set_index("employee_id"))
                else:
                    st.warning("Tidak ada hasil ditemukan dari scoring.")

                # --- 2Ô∏è‚É£ Generate AI Job Profile ---
                ai_profile = generate_job_profile(selected_role, selected_job_level, role_purpose)

                # --- Tampilkan hasil AI Job Profile ---
                if ai_profile and not ai_profile.startswith("‚ö†Ô∏è"):
                    st.subheader("üß† AI-Generated Job Profile")

                    clean_text = re.sub(r"<[^>]*>", "", ai_profile)
                    clean_text = clean_text.replace("&nbsp;", " ").replace("&amp;", "&").strip()

                    st.write(clean_text)
                    st.session_state["ai_job_profile"] = clean_text  # simpan untuk langkah selanjutnya
                else:
                    st.warning(ai_profile)

            except Exception as e:
                st.error(f"Terjadi kesalahan saat menjalankan analisis: {e}")



# ==========================================================
# üß± STEP 6: JOB DETAILS FORM (AI + Add/Remove + Dropdown)
# ==========================================================
st.markdown("---")
st.subheader("3Ô∏è‚É£ Job Details Form")

# --- tampilkan hanya setelah AI profile ada ---
if "ai_job_profile" not in st.session_state:
    st.info("‚ö†Ô∏è Jalankan dulu '‚ú® Generate Job Profile' supaya AI bisa isi form otomatis.")
    st.stop()

# --- parsing AI text jadi list poin ---
def parse_ai_sections(ai_text):
    sections = {"responsibilities": [], "qualifications": [], "competencies": []}
    current = None
    for line in ai_text.split("\n"):
        line = line.strip()
        if not line:
            continue
        if "responsibilit" in line.lower() or "job description" in line.lower():
            current = "responsibilities"
            continue
        elif "requirement" in line.lower() or "qualification" in line.lower():
            current = "qualifications"
            continue
        elif "competenc" in line.lower() or "skill" in line.lower():
            current = "competencies"
            continue
        if current:
            clean = line.lstrip("-‚Ä¢1234567890. ").strip()
            if clean and len(clean.split()) > 2:
                sections[current].append(clean)
    return sections


# --- inisialisasi data job form ---
if "job_form" not in st.session_state:
    parsed = parse_ai_sections(st.session_state["ai_job_profile"])
    st.session_state.job_form = {
        "responsibilities": parsed.get("responsibilities", []),
        "work_inputs": [],
        "work_outputs": [],
        "qualifications": parsed.get("qualifications", []),
        "competencies": parsed.get("competencies", [])
    }

# --- daftar opsi umum untuk dropdown ---
default_options = {
    "responsibilities": [
        "Analyze large datasets to extract insights",
        "Develop and maintain dashboards",
        "Collaborate with cross-functional teams",
        "Ensure data accuracy and integrity",
        "Automate repetitive reporting tasks"
    ],
    "work_inputs": [
        "Raw transactional data",
        "Customer feedback reports",
        "Sales and marketing metrics",
        "Operational performance data"
    ],
    "work_outputs": [
        "Monthly performance reports",
        "KPI dashboards",
        "Ad-hoc analysis summaries",
        "Data-driven recommendations"
    ],
    "qualifications": [
        "Bachelor‚Äôs degree in Statistics, Mathematics, or related field",
        "Proficiency in SQL and Python",
        "Experience with data visualization tools",
        "Strong analytical and problem-solving skills"
    ],
    "competencies": [
        "Analytical Thinking",
        "Attention to Detail",
        "Collaboration",
        "Adaptability",
        "Time Management"
    ]
}

# --- fungsi tambah & hapus item ---
def add_item(section):
    st.session_state.job_form[section].append("")

def remove_item(section, index):
    st.session_state.job_form[section].pop(index)

# --- render tiap bagian form ---
section_labels = {
    "responsibilities": "üß© Key Responsibilities",
    "work_inputs": "üì• Work Inputs",
    "work_outputs": "üì§ Work Outputs",
    "qualifications": "üéì Qualifications",
    "competencies": "üí° Competencies"
}

for section, label in section_labels.items():
    st.markdown(f"**{label}**")

    items = st.session_state.job_form[section]

    for i, val in enumerate(items):
        cols = st.columns([6, 2, 1])
        with cols[0]:
            st.session_state.job_form[section][i] = st.text_input(
                f"{label} {i+1}",
                value=val,
                key=f"{section}_{i}"
            )
        with cols[1]:
            new_val = st.selectbox(
                "Quick Add",
                ["‚Äî Select from template ‚Äî"] + default_options[section],
                key=f"dropdown_{section}_{i}"
            )
            if new_val != "‚Äî Select from template ‚Äî":
                st.session_state.job_form[section][i] = new_val
        with cols[2]:
            if st.button("‚ùå", key=f"del_{section}_{i}"):
                remove_item(section, i)
                st.experimental_rerun()

    # tombol Add di bawah setiap section
    if st.button(f"‚ûï Add {label}", key=f"add_{section}"):
        add_item(section)
        st.experimental_rerun()

    st.markdown("---")

# --- tombol simpan ---
if st.button("üíæ Save Job Details"):
    try:
        data_insert = {
            "role_name": selected_role,
            "job_level": selected_job_level,
            "responsibilities": json.dumps(st.session_state.job_form["responsibilities"]),
            "work_inputs": json.dumps(st.session_state.job_form["work_inputs"]),
            "work_outputs": json.dumps(st.session_state.job_form["work_outputs"]),
            "qualifications": json.dumps(st.session_state.job_form["qualifications"]),
            "competencies": json.dumps(st.session_state.job_form["competencies"]),
            "created_at": datetime.now().isoformat()
        }
        supabase.table("job_details").insert(data_insert).execute()
        st.success("‚úÖ Job Details berhasil disimpan ke Supabase!")
    except Exception as e:
        st.error(f"Gagal menyimpan ke Supabase: {e}")
