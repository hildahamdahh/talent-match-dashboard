# -*- coding: utf-8 -*-
"""Untitled17.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1eXC7zJPr4XJ4uHj5cjOkW1G50y_8Vbj-
"""

# ==========================================================
# üéØ Talent Match Intelligence Dashboard (FINAL + JOB DETAILS)
# ==========================================================
import streamlit as st
from supabase import create_client, Client
import pandas as pd
import requests
import json
import re
from datetime import datetime

# --- Koneksi ke Supabase ---
url = "https://cckdfjxowgowgxufnhnj.supabase.co"
key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNja2Rmanhvd2dvd2d4dWZuaG5qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NDY4NDgsImV4cCI6MjA3NzEyMjg0OH0.JXb-yqbBu_OSLpG03AlnfZI5K_eRKyhfGw4glE0Cj0o"
supabase: Client = create_client(url, key)

# --- Page Setup ---
st.set_page_config(page_title="Talent Match Intelligence", layout="wide")
st.title("üéØ Talent Match Intelligence Dashboard")

# ==========================================================
# üß© STEP 1: Ambil data benchmark dari Supabase
# ==========================================================
try:
    response = supabase.table("talent_benchmark").select("*").execute()
    benchmark_data = response.data
except Exception as e:
    st.error(f"Gagal mengambil data: {e}")
    st.stop()

if not benchmark_data:
    st.warning("Tabel 'talent_benchmark' masih kosong.")
    st.stop()

df_benchmark = pd.DataFrame(benchmark_data)

# ==========================================================
# üß≠ STEP 2: Input dari user (parameter runtime)
# ==========================================================
st.subheader("1Ô∏è‚É£ Role Information")

role_names = sorted(df_benchmark["role_name"].dropna().unique())
selected_role = st.selectbox("Role Name", role_names)

filtered_df = df_benchmark[df_benchmark["role_name"] == selected_role]
job_levels = filtered_df["job_level"].dropna().unique()
selected_job_level = st.selectbox("Job Level", job_levels)

role_purpose = st.text_area(
    "Role Purpose",
    placeholder="Contoh: Ensure production targets are met with optimal quality and cost efficiency"
)

# ==========================================================
# üë• STEP 3: Pilih Employee Benchmark
# ==========================================================
st.subheader("2Ô∏è‚É£ Employee Benchmarking")

employee_options = [
    f"{row['employee_id']} - {row['fullname']} ({row['role_name']})"
    for _, row in filtered_df.iterrows()
]
selected_employees = st.multiselect(
    "Pilih maksimal 3 karyawan sebagai benchmark:",
    options=employee_options,
    max_selections=3
)
selected_ids = [emp.split(" - ")[0] for emp in selected_employees]

# ==========================================================
# üß† STEP 4: AI Job Profile Generator (OpenRouter)
# ==========================================================
def generate_job_profile(role_name, job_level, role_purpose):
    try:
        OPENROUTER_API_KEY = st.secrets["OPENROUTER_API_KEY"]
    except Exception:
        st.error("‚ùå OPENROUTER_API_KEY belum diset di secrets.")
        return None

    headers = {
        "Authorization": f"Bearer {OPENROUTER_API_KEY}",
        "HTTP-Referer": "https://talent-match-intelligence.streamlit.app",
        "X-Title": "Talent Match Intelligence",
        "Content-Type": "application/json",
    }

    prompt = f"""
    You are an HR Talent Intelligence Assistant.
    Generate a clear, structured job profile for a {job_level} {role_name}.
    Include:
    1Ô∏è‚É£ Job Requirements
    2Ô∏è‚É£ Job Description
    3Ô∏è‚É£ Key Competencies
    Context: {role_purpose}
    """

    payload = {
        "model": "openai/gpt-4o-mini",
        "messages": [
            {"role": "system", "content": "You generate concise job profiles for HR."},
            {"role": "user", "content": prompt}
        ]
    }

    response = requests.post(
        "https://openrouter.ai/api/v1/chat/completions",
        headers=headers,
        data=json.dumps(payload)
    )

    if response.status_code == 200:
        return response.json()["choices"][0]["message"]["content"]
    else:
        return f"‚ö†Ô∏è Error dari OpenRouter: {response.status_code} - {response.text}"


# ==========================================================
# üöÄ STEP 5: COMBINED BUTTON (SQL + AI)
# ==========================================================
if st.button("‚ú® Generate Job Profile & Variable Score"):
    if not selected_ids:
        st.warning("Pilih minimal 1 benchmark employee terlebih dahulu.")
    else:
        with st.spinner("‚è≥ Menjalankan analisis dan AI generation..."):
            try:
                # --- 1Ô∏è‚É£ Jalankan Function di Supabase ---
                result = supabase.rpc("talent_match_scoring", {"benchmark_ids": selected_ids}).execute()
                data = result.data

                if data:
                    df_result = pd.DataFrame(data)
                    st.success(f"Hasil untuk role: {selected_role} (Job Level: {selected_job_level})")

                    rank_df = (
                        df_result[["employee_id", "final_match_rate"]]
                        .drop_duplicates()
                        .sort_values(by="final_match_rate", ascending=False)
                    )

                    st.subheader("üìä Final Match Rate per Employee")
                    st.dataframe(rank_df)
                    st.bar_chart(rank_df.set_index("employee_id"))
                else:
                    st.warning("Tidak ada hasil ditemukan dari scoring.")

                # --- 2Ô∏è‚É£ Generate AI Job Profile ---
                ai_profile = generate_job_profile(selected_role, selected_job_level, role_purpose)

                # --- Tampilkan hasil AI Job Profile ---
                if ai_profile and not ai_profile.startswith("‚ö†Ô∏è"):
                    st.subheader("üß† AI-Generated Job Profile")

                    clean_text = re.sub(r"<[^>]*>", "", ai_profile)
                    clean_text = clean_text.replace("&nbsp;", " ").replace("&amp;", "&").strip()

                    st.write(clean_text)
                    st.session_state["ai_job_profile"] = clean_text  # simpan untuk langkah selanjutnya
                else:
                    st.warning(ai_profile)

            except Exception as e:
                st.error(f"Terjadi kesalahan saat menjalankan analisis: {e}")




# ==========================================================
# üéØ STEP 6 (REVISED): JOB DETAILS FORM (Requirements + Competencies)
# ==========================================================
# ==========================================================
# üéØ STEP 6 (Final Polished): Job Details Form (2 Section)
# ==========================================================
import streamlit as st
import re

st.markdown("---")
st.subheader("3Ô∏è‚É£ Job Details Form")

if "ai_job_profile" not in st.session_state:
    st.info("‚ö†Ô∏è Jalankan dulu 'Generate Job Profile' agar AI dapat mengisi dropdown otomatis.")
else:
    ai_text = st.session_state["ai_job_profile"]

    # ====== Ekstraksi otomatis poin dari hasil AI ======
    def extract_bullets(text):
        bullets = re.findall(r"[-‚Ä¢]\s*(.+)", text)
        return [b.strip() for b in bullets if len(b.strip()) > 2]

    # Pisahkan bagian Requirements & Competencies dari teks AI
    req_raw = re.findall(r"(?i)(?:requirement[s]?:|qualification[s]?:)([\s\S]*?)(?:competenc|$)", ai_text)
    comp_raw = re.findall(r"(?i)(?:competenc[y|ies]:)([\s\S]*)", ai_text)
    req_list = extract_bullets(req_raw[0]) if req_raw else []
    comp_list = extract_bullets(comp_raw[0]) if comp_raw else []

    # ====== Persingkat setiap poin jadi singkat dan ringkas ======
    def shorten_point(point):
        point = re.sub(r"\bexperience\b.*", "", point, flags=re.I)
        point = re.sub(r"\b(proficiency in|ability to|knowledge of)\b", "", point, flags=re.I)
        point = re.sub(r"[.,;].*", "", point)
        point = re.sub(r"\s{2,}", " ", point)
        return point.strip().capitalize()

    req_list = [shorten_point(p) for p in req_list if p]
    comp_list = [shorten_point(p) for p in comp_list if p]

    # ====== State management ======
    if "requirements" not in st.session_state:
        st.session_state.requirements = []
    if "competencies" not in st.session_state:
        st.session_state.competencies = []

    # ====== Fungsi Render Section ======
    def render_section(title, key, ai_suggestions):
        st.markdown(f"### {title}")

        # Kotak border halus
        with st.container(border=True):
            # Input dan tombol sejajar
            cols = st.columns([8, 1])
            with cols[0]:
                new_item = st.text_input("Add an item", key=f"input_{key}", label_visibility="collapsed")
            with cols[1]:
                add_btn = st.button("‚ûï", key=f"add_{key}")

            # Dropdown dari AI suggestions
            if ai_suggestions:
                selected_suggestion = st.selectbox(
                    "AI Suggestions",
                    options=[""] + ai_suggestions,
                    key=f"dropdown_{key}",
                    label_visibility="collapsed",
                    help="Pilih dari hasil AI"
                )
                if selected_suggestion:
                    if st.button("Add from AI", key=f"add_ai_{key}"):
                        if selected_suggestion not in st.session_state[key]:
                            st.session_state[key].append(selected_suggestion)

            # Tambahkan item manual
            if add_btn and new_item.strip():
                st.session_state[key].append(new_item.strip())
                st.session_state[f"input_{key}"] = ""  # reset input

            # List item dengan bullet, edit, delete
            for i, item in enumerate(st.session_state[key]):
                cols = st.columns([10, 1, 1])
                with cols[0]:
                    st.markdown(f"‚Ä¢ **{item}**")
                with cols[1]:
                    if st.button("‚úèÔ∏è", key=f"edit_{key}_{i}"):
                        st.session_state[f"edit_index_{key}"] = i
                with cols[2]:
                    if st.button("‚ùå", key=f"del_{key}_{i}"):
                        st.session_state[key].pop(i)
                        st.rerun()

                # Mode edit
                if st.session_state.get(f"edit_index_{key}") == i:
                    edited_text = st.text_input("Edit item", value=item, key=f"editbox_{key}_{i}")
                    if st.button("Save", key=f"save_{key}_{i}"):
                        st.session_state[key][i] = edited_text
                        del st.session_state[f"edit_index_{key}"]
                        st.rerun()

    # ====== Render dua section utama ======
    render_section("Requirements", "requirements", req_list)
    render_section("Competencies", "competencies", comp_list)

    # ====== Tombol Simpan ======
    if st.button("üíæ Save Job Details"):
        try:
            data_insert = {
                "role_name": selected_role,
                "job_level": selected_job_level,
                "requirements": st.session_state["requirements"],
                "competencies": st.session_state["competencies"],
                "created_at": datetime.now().isoformat()
            }
            supabase.table("job_details").insert(data_insert).execute()
            st.success("‚úÖ Job Details berhasil disimpan ke Supabase!")
        except Exception as e:
            st.error(f"Gagal menyimpan ke Supabase: {e}")
